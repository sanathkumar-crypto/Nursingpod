<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Pod Quality Dashboard</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="row">
                <div class="col-10">
                    <h1 class="main-title">Nursing Pod Quality Dashboard</h1>
                    <p class="subtitle">Real-time monitoring and analysis of nursing pod escalations</p>
                </div>
                <div class="col-2 text-end">
                    <div class="user-info">
                        <p class="user-email mb-1">{{ current_user.email }}</p>
                        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-light">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Filters Section -->
        <section class="filters-section">
            <div class="row">
                <div class="col-12">
                    <div class="card filter-card">
                        <div class="card-header">
                            <h3 class="card-title">Data Filters</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="escalation-filter" class="form-label">Escalation Type</label>
                                    <select class="form-select" id="escalation-filter">
                                        <option value="all">All Escalations</option>
                                        {% for escalation in filter_options.escalations %}
                                        <option value="{{ escalation }}">{{ escalation }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="exclude-camera-annotations" value="1">
                                        <label class="form-check-label" for="exclude-camera-annotations">
                                            Exclude Camera Annotations
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="email-filter" class="form-label">Nurse Email</label>
                                    <select class="form-select" id="email-filter">
                                        <option value="all">All Nurses</option>
                                        {% for email in filter_options.emails %}
                                        <option value="{{ email }}">{{ email }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="hospital-filter" class="form-label">Hospital</label>
                                    <select class="form-select" id="hospital-filter" multiple>
                                        {% for hospital in filter_options.hospitals %}
                                        <option value="{{ hospital }}">{{ hospital }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-hospitals">Select All</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="unselect-all-hospitals">Unselect All</button>
                                    </div>
                                    <small class="form-text text-muted">Select multiple hospitals (all selected by default)</small>
                                </div>
        <div class="col-md-3">
            <label for="date-range-filter" class="form-label">Date Range</label>
            <div class="input-group">
                <input type="date" class="form-control" id="start-date" placeholder="Start Date">
                <span class="input-group-text">to</span>
                <input type="date" class="form-control" id="end-date" placeholder="End Date">
            </div>
            <small class="form-text text-muted">Leave empty for all dates</small>
        </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
                                    <button class="btn btn-secondary" id="reset-filters">Reset</button>
                                    <span class="filter-status" id="filter-status"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="charts-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3 class="card-title">Monthly Trends</h3>
                        </div>
                        <div class="card-body">
                            <div id="monthly-trend-chart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3 class="card-title">Escalation Distribution (Top 5 + Others)</h3>
                        </div>
                        <div class="card-body">
                            <div id="escalation-distribution-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Nurse-wise Trend Chart (shown only for Camera Annotations) -->
            <div class="row mt-3" id="nurse-wise-trend-row" style="display: none;">
                <div class="col-12">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h3 class="card-title">Nurse-wise Month-on-Month Trend</h3>
                        </div>
                        <div class="card-body">
                            <div id="nurse-wise-trend-chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Table Section -->
        <section class="data-section">
            <div class="row">
                <div class="col-12">
                    <div class="card data-card">
                        <div class="card-header">
                            <h3 class="card-title">Filtered Data</h3>
                            <span class="data-count" id="data-count">Loading...</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <div id="data-table-container">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- jQuery (required for Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    
    <!-- Initialize charts -->
    <script>
        // Log console availability
        console.log('=================================');
        console.log('Nursing Pod Dashboard Loading...');
        console.log('Console is working!');
        console.log('Page loaded at:', new Date().toISOString());
        console.log('=================================');
        
        try {
            console.log('Initializing charts...');
            // Monthly trend chart
            var monthlyTrendData = {{ monthly_trend | safe }};
            console.log('Monthly trend data loaded:', Object.keys(monthlyTrendData));
            if (!monthlyTrendData.layout.height) {
                monthlyTrendData.layout.height = 500;
            }
            if (!monthlyTrendData.layout.autosize) {
                monthlyTrendData.layout.autosize = true;
            }
            Plotly.newPlot('monthly-trend-chart', monthlyTrendData.data, monthlyTrendData.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['toImage']
            });
            console.log('Monthly trend chart initialized');
            
            // Escalation distribution chart
            var escalationDistData = {{ escalation_dist | safe }};
            console.log('Escalation distribution data loaded:', Object.keys(escalationDistData));
            if (!escalationDistData.layout.height) {
                escalationDistData.layout.height = 500;
            }
            if (!escalationDistData.layout.autosize) {
                escalationDistData.layout.autosize = true;
            }
            Plotly.newPlot('escalation-distribution-chart', escalationDistData.data, escalationDistData.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['toImage']
            });
            console.log('Escalation distribution chart initialized');
            console.log('All charts initialized successfully!');
        } catch (error) {
            console.error('ERROR initializing charts:', error);
            console.error('Error stack:', error.stack);
        }
    </script>
</body>
</html>
